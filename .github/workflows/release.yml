name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service: [frontend, backend, worker]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  create-release:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create installer script
        run: |
          cat > simple-docking-installer.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ğŸš€ Simple Docking Dashboard ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼"
          echo ""

          # Dockerãƒã‚§ãƒƒã‚¯
          if ! command -v docker &> /dev/null; then
            echo "âŒ Docker ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "   https://docs.docker.com/get-docker/ ã‚’å‚ç…§ã—ã¦ãã ã•ã„"
            exit 1
          fi

          # Docker Composeãƒã‚§ãƒƒã‚¯
          if ! docker compose version &> /dev/null; then
            echo "âŒ Docker Compose ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi

          echo "âœ… Docker ç’°å¢ƒã‚’ç¢ºèªã—ã¾ã—ãŸ"
          echo ""

          # ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
          if [ -d "simple-docking" ]; then
            echo "ğŸ“ æ—¢å­˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            cd simple-docking
            git pull
          else
            echo "ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ä¸­..."
            git clone https://github.com/${GITHUB_REPOSITORY}.git simple-docking
            cd simple-docking
          fi

          # docker-compose.ymlã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒªãƒªãƒ¼ã‚¹ç‰ˆï¼‰
          echo "ğŸ“¥ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
          curl -fsSL https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${GITHUB_REF_NAME}/docker-compose.yml -o docker-compose.yml

          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pull
          echo "ğŸ“¦ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
          docker compose pull

          # èµ·å‹•
          echo "ğŸš€ ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ä¸­..."
          docker compose up -d

          echo ""
          echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ï¼"
          echo ""
          echo "ğŸ“± ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„:"
          echo "   http://localhost:8090/simple-docking"
          echo ""
          echo "ğŸ“ åœæ­¢ã™ã‚‹å ´åˆ:"
          echo "   docker compose down"
          echo ""
          echo "ğŸ“ ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹å ´åˆ:"
          echo "   docker compose logs -f"
          EOF

          chmod +x simple-docking-installer.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            simple-docking-installer.sh
            docker-compose.yml
          body: |
            ## Simple Docking Dashboard ${{ github.ref_name }}

            ### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

            #### Linux/Mac
            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/simple-docking-installer.sh | bash
            ```

            ã¾ãŸã¯æ‰‹å‹•ã§:
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/simple-docking-installer.sh
            chmod +x simple-docking-installer.sh
            ./simple-docking-installer.sh
            ```

            #### å¿…è¦ãªç’°å¢ƒ
            - Docker 20.10+
            - Docker Compose V2+

            ### ã‚¢ã‚¯ã‚»ã‚¹
            http://localhost:8090/simple-docking

            ### å¤‰æ›´ç‚¹
            è©³ç´°ã¯ [CHANGELOG](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/docs/roadmap.md) ã‚’å‚ç…§
