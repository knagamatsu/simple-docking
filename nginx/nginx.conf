events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Docker internal DNS
    resolver 127.0.0.11 valid=30s;

    server {
        listen 80;

        # Redirect root to subpath
        location = / {
            return 302 /simple-docking/;
        }

        # Frontend
        location /simple-docking/ {
            set $frontend_upstream "frontend:3000";
            
            # Remove /simple-docking/ prefix before passing to frontend
            # Vite dev server expects req.url to behave a certain way, but 
            # usually if we set base='/simple-docking/', the index.html refers to assets with valid paths.
            # However, proxying:
            # If default vite is serving at /, and we access /simple-docking/,
            # we might need to rewrite. 
            # But if we configure vite base='/simple-docking/', it serves at /simple-docking/.
            # So we pass it as is.
            
            proxy_pass http://$frontend_upstream;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Backend API
        location /simple-docking/api/ {
            set $api_upstream "api:8000";
            # Rewrite /simple-docking/api/foo -> /foo
            rewrite ^/simple-docking/api/(.*) /$1 break;
            proxy_pass http://$api_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
